# s02: Tools (å·¥å…·)

> ä¸€ä¸ªåˆ†å‘æ˜ å°„è¡¨ (dispatch map) å°†å·¥å…·è°ƒç”¨è·¯ç”±åˆ°å¤„ç†å‡½æ•° -- å¾ªç¯æœ¬èº«å®Œå…¨ä¸éœ€è¦æ”¹åŠ¨ã€‚

## é—®é¢˜

åªæœ‰ `bash` æ—¶, æ™ºèƒ½ä½“æ‰€æœ‰æ“ä½œéƒ½é€šè¿‡ shell: è¯»æ–‡ä»¶ã€å†™æ–‡ä»¶ã€ç¼–è¾‘æ–‡ä»¶ã€‚è¿™èƒ½ç”¨ä½†å¾ˆè„†å¼±ã€‚`cat` çš„è¾“å‡ºä¼šè¢«ä¸å¯é¢„æµ‹åœ°æˆªæ–­ã€‚`sed` æ›¿æ¢é‡åˆ°ç‰¹æ®Šå­—ç¬¦å°±ä¼šå¤±è´¥ã€‚æ¨¡å‹æµªè´¹å¤§é‡ token æ„é€  shell ç®¡é“, è€Œä¸€ä¸ªç›´æ¥çš„å‡½æ•°è°ƒç”¨ä¼šç®€å•å¾—å¤šã€‚

æ›´é‡è¦çš„æ˜¯, bash å­˜åœ¨å®‰å…¨é£é™©ã€‚æ¯æ¬¡ bash è°ƒç”¨éƒ½èƒ½åš shell èƒ½åšçš„ä¸€åˆ‡ã€‚æœ‰äº†ä¸“ç”¨å·¥å…·å¦‚ `read_file` å’Œ `write_file`, ä½ å¯ä»¥åœ¨å·¥å…·å±‚é¢å¼ºåˆ¶è·¯å¾„æ²™ç®±åŒ–, é˜»æ­¢å±é™©æ¨¡å¼, è€Œä¸æ˜¯å¯„å¸Œæœ›äºæ¨¡å‹è‡ªè§‰å›é¿ã€‚

å…³é”®æ´å¯Ÿ: æ·»åŠ å·¥å…·ä¸éœ€è¦ä¿®æ”¹å¾ªç¯ã€‚s01 çš„å¾ªç¯ä¿æŒä¸å˜ã€‚ä½ åªéœ€åœ¨å·¥å…·æ•°ç»„ä¸­æ·»åŠ æ¡ç›®, ç¼–å†™å¤„ç†å‡½æ•°, ç„¶åé€šè¿‡ dispatch map æŠŠå®ƒä»¬å…³è”èµ·æ¥ã€‚

## è§£å†³æ–¹æ¡ˆ

```
+----------+      +-------+      +------------------+
|   User   | ---> |  LLM  | ---> | Tool Dispatch    |
|  prompt  |      |       |      | {                |
+----------+      +---+---+      |   bash: run_bash |
                      ^          |   read: run_read |
                      |          |   write: run_wr  |
                      +----------+   edit: run_edit |
                      tool_result| }                |
                                 +------------------+

The dispatch map is a dict: {tool_name: handler_function}
One lookup replaces any if/elif chain.
```

## å·¥ä½œåŸç†

1. ä¸ºæ¯ä¸ªå·¥å…·å®šä¹‰å¤„ç†å‡½æ•°ã€‚æ¯ä¸ªå‡½æ•°æ¥å—ä¸å·¥å…· input_schema å¯¹åº”çš„å…³é”®å­—å‚æ•°, è¿”å›å­—ç¬¦ä¸²ç»“æœã€‚

```python
def run_read(path: str, limit: int = None) -> str:
    text = safe_path(path).read_text()
    lines = text.splitlines()
    if limit and limit < len(lines):
        lines = lines[:limit]
    return "\n".join(lines)[:50000]
```

2. åˆ›å»º dispatch map, å°†å·¥å…·åæ˜ å°„åˆ°å¤„ç†å‡½æ•°ã€‚

```python
TOOL_HANDLERS = {
    "bash":       lambda **kw: run_bash(kw["command"]),
    "read_file":  lambda **kw: run_read(kw["path"], kw.get("limit")),
    "write_file": lambda **kw: run_write(kw["path"], kw["content"]),
    "edit_file":  lambda **kw: run_edit(kw["path"], kw["old_text"],
                                        kw["new_text"]),
}
```

3. åœ¨ agent loop ä¸­, æŒ‰åç§°æŸ¥æ‰¾å¤„ç†å‡½æ•°, è€Œä¸æ˜¯ç¡¬ç¼–ç ã€‚

```python
for block in response.content:
    if block.type == "tool_use":
        handler = TOOL_HANDLERS.get(block.name)
        output = handler(**block.input)
        results.append({
            "type": "tool_result",
            "tool_use_id": block.id,
            "content": output,
        })
```

4. è·¯å¾„æ²™ç®±åŒ–é˜²æ­¢æ¨¡å‹é€ƒé€¸å‡ºå·¥ä½œåŒºã€‚

```python
def safe_path(p: str) -> Path:
    path = (WORKDIR / p).resolve()
    if not path.is_relative_to(WORKDIR):
        raise ValueError(f"Path escapes workspace: {p}")
    return path
```

## æ ¸å¿ƒä»£ç 

dispatch æ¨¡å¼ (æ¥è‡ª `agents/s02_tool_use.py`, ç¬¬ 93-129 è¡Œ):

```python
TOOL_HANDLERS = {
    "bash":       lambda **kw: run_bash(kw["command"]),
    "read_file":  lambda **kw: run_read(kw["path"], kw.get("limit")),
    "write_file": lambda **kw: run_write(kw["path"], kw["content"]),
    "edit_file":  lambda **kw: run_edit(kw["path"], kw["old_text"],
                                        kw["new_text"]),
}

def agent_loop(messages: list):
    while True:
        response = client.messages.create(
            model=MODEL, system=SYSTEM, messages=messages,
            tools=TOOLS, max_tokens=8000,
        )
        messages.append({"role": "assistant", "content": response.content})
        if response.stop_reason != "tool_use":
            return
        results = []
        for block in response.content:
            if block.type == "tool_use":
                handler = TOOL_HANDLERS.get(block.name)
                output = handler(**block.input) if handler \
                    else f"Unknown tool: {block.name}"
                results.append({
                    "type": "tool_result",
                    "tool_use_id": block.id,
                    "content": output,
                })
        messages.append({"role": "user", "content": results})
```

## ç›¸å¯¹ s01 çš„å˜æ›´

| ç»„ä»¶           | ä¹‹å‰ (s01)         | ä¹‹å (s02)                     |
|----------------|--------------------|----------------------------|
| Tools          | 1 (ä»… bash)        | 4 (bash, read, write, edit)|
| Dispatch       | ç¡¬ç¼–ç  bash è°ƒç”¨   | `TOOL_HANDLERS` å­—å…¸       |
| è·¯å¾„å®‰å…¨       | æ—                  | `safe_path()` æ²™ç®±         |
| Agent loop     | ä¸å˜               | ä¸å˜                       |

## è®¾è®¡åŸç†

dispatch map æ¨¡å¼å¯ä»¥çº¿æ€§æ‰©å±• -- æ·»åŠ å·¥å…·åªéœ€æ·»åŠ ä¸€ä¸ªå¤„ç†å‡½æ•°å’Œä¸€ä¸ª schema æ¡ç›®ã€‚å¾ªç¯æ°¸è¿œä¸éœ€è¦æ”¹åŠ¨ã€‚è¿™ç§å…³æ³¨ç‚¹åˆ†ç¦» (å¾ªç¯ vs å¤„ç†å‡½æ•°) æ˜¯æ™ºèƒ½ä½“æ¡†æ¶èƒ½æ”¯æŒæ•°åä¸ªå·¥å…·è€Œä¸å¢åŠ æ§åˆ¶æµå¤æ‚åº¦çš„åŸå› ã€‚è¯¥æ¨¡å¼è¿˜æ”¯æŒå¯¹æ¯ä¸ªå¤„ç†å‡½æ•°è¿›è¡Œç‹¬ç«‹æµ‹è¯•, å› ä¸ºå¤„ç†å‡½æ•°æ˜¯ä¸å¾ªç¯æ— è€¦åˆçš„çº¯å‡½æ•°ã€‚ä»»ä½•è¶…å‡º dispatch map çš„æ™ºèƒ½ä½“éƒ½æ˜¯è®¾è®¡é—®é¢˜, è€Œéæ‰©å±•é—®é¢˜ã€‚

## è¯•ä¸€è¯•

```sh
cd learn-claude-code
python agents/s02_tool_use.py
```

å¯ä»¥å°è¯•çš„æç¤º:

1. `Read the file requirements.txt`
2. `Create a file called greet.py with a greet(name) function`
3. `Edit greet.py to add a docstring to the function`
4. `Read greet.py to verify the edit worked`
5. `Run the greet function with bash: python -c "from greet import greet; greet('World')"`





```
Message(id='05eeeba0ba90928f32ae19f3143d7221', container=None, content=[ThinkingBlock(signature='bb5628cb2205c01e68a39ad2a2e946181b007c71e9d173be195c6612cde2ad55', thinking='ç”¨æˆ·æƒ³è¦æ‰¾åˆ° scripts ç›®å½•å¹¶è¿”å›å…¶ç›¸å¯¹è·¯å¾„ã€‚æˆ‘éœ€è¦å…ˆæŸ¥çœ‹å½“å‰ç›®å½•ç»“æ„ï¼Œæ‰¾åˆ° scripts ç›®å½•çš„ä½ç½®ã€‚\n\nè®©æˆ‘å…ˆæŸ¥çœ‹å½“å‰ç›®å½•ä¸‹æœ‰å“ªäº›æ–‡ä»¶å’Œæ–‡ä»¶å¤¹ã€‚', type='thinking'), 

ToolUseBlock(id='call_function_67y24wi0gq2d_1', caller=None, input={'command': 'ls -la'}, name='bash', type='tool_use')], model='MiniMax-M2.5', role='assistant', stop_reason='tool_use', stop_sequence=None, type='message', usage=Usage(cache_creation=None, cache_creation_input_tokens=None, cache_read_input_tokens=None, inference_geo=None, input_tokens=393, output_tokens=61, server_tool_use=None, service_tier=None), base_resp={'status_code': 0, 'status_msg': ''})
```



```

[{'role': 'user', 'content': 'å…ˆæ‰¾åˆ°scriptsç›®å½•ï¼Œå¹¶è¿”å›è¯¥ç›®å½•çš„ç›¸å¯¹è·¯å¾„'}, {'role': 'assistant', 'content': [...]}]

'content': [ThinkingBlock(signature='bb5628cb2205c01e68a39ad2a2e946181b007c71e9d173be195c6612cde2...n\nè®©æˆ‘å…ˆæŸ¥çœ‹å½“å‰ç›®å½•ä¸‹æœ‰å“ªäº›æ–‡ä»¶å’Œæ–‡ä»¶å¤¹ã€‚', type='thinking'), ToolUseBlock(id='call_function_67y24wi0gq2d_1', caller=None, input={'command': 'ls -la'}, name='bash', type='tool_use')]
```



```
Message(id='05eef32a20055f47ab598b136d57b774', container=None, content=[ThinkingBlock(signature='35e5ed736453c37693d9ae5a0a142005f86dffdc37c45833ad32e10da935fdc8', thinking='ç”¨æˆ·è¦æ±‚åœ¨scriptsç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªall.txtæ–‡ä»¶ã€‚æˆ‘éœ€è¦å…ˆæ£€æŸ¥scriptsç›®å½•æ˜¯å¦å­˜åœ¨ï¼Œç„¶ååˆ›å»ºè¿™ä¸ªæ–‡ä»¶ã€‚', type='thinking'), 

ToolUseBlock(id='call_function_un1nnaknbk2t_1', caller=None, input={'command': 'ls -la scripts 2>/dev/null || echo "Directory does not exist"'}, name='bash', type='tool_use')], model='MiniMax-M2.5', role='assistant', stop_reason='tool_use', stop_sequence=None, type='message', usage=Usage(cache_creation=None, cache_creation_input_tokens=None, cache_read_input_tokens=None, inference_geo=None, input_tokens=389, output_tokens=62, server_tool_use=None, service_tier=None), base_resp={'status_code': 0, 'status_msg': ''})
```



## 1) s02 åœ¨è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ

ä½ å‰é¢å†™å¾—å¾ˆæ¸…æ¥šï¼š**åªæœ‰ bash ä¸€ä¸ªå·¥å…·æ—¶**ï¼Œæ™ºèƒ½ä½“æ‰€æœ‰åŠ¨ä½œéƒ½è¦æ‹¼ shell å‘½ä»¤æ¥å®Œæˆã€‚

è¿™ä¼šå¸¦æ¥ä¸‰ç±»å…¸å‹ç—›ç‚¹ï¼š

- **è„†å¼±/ä¸ç¨³å®š**
  - `cat` è¾“å‡ºå¯èƒ½è¢«æˆªæ–­ï¼ˆæ¨¡å‹ç«¯æˆ–ä¸­é—´å±‚å¯èƒ½æœ‰é•¿åº¦é™åˆ¶ï¼‰
  - `sed` ä¹‹ç±»æ›¿æ¢é‡åˆ°ç‰¹æ®Šå­—ç¬¦ã€æ¢è¡Œã€æ­£åˆ™è½¬ä¹‰å°±å®¹æ˜“ç¿»è½¦
  - æ¨¡å‹å¾—æµªè´¹å¾ˆå¤š token å»å†™â€œç®¡é“å‘½ä»¤â€ï¼Œè¿˜ä¸ä¸€å®šå¯¹
- **å®‰å…¨é£é™©**
  - bash èƒ½åšçš„å¤ªå¤šäº†ï¼šåˆ åº“ã€è”ç½‘ã€è·‘ä»»æ„ç¨‹åºã€è¯»ç³»ç»Ÿæ•æ„Ÿè·¯å¾„â€¦â€¦
  - ä½ æƒ³è¦çš„æ˜¯ï¼šå·¥å…·å±‚é¢æŠŠèƒ½åŠ›â€œå‰ªè£â€åˆ°åªå…è®¸åšå®‰å…¨åŠ¨ä½œ
- **æ‰©å±•å›°éš¾**
  - å¦‚æœä½ ç”¨ if/elif å†™æ­» â€œå¦‚æœæ˜¯ bash å°± run_bash()â€ï¼Œä»¥ååŠ å·¥å…·å°±å¾—æ”¹å¾ªç¯æ§åˆ¶æµ

------

## 2) æ ¸å¿ƒæ´å¯Ÿï¼š**åŠ å·¥å…·ä¸éœ€è¦æ”¹ agent loop**

s02 çš„å…³é”®ç‚¹æ˜¯ï¼šæŠŠâ€œæ€ä¹ˆè°ƒç”¨å·¥å…·â€ä»å¾ªç¯é‡ŒæŠ½å‡ºæ¥ï¼Œå˜æˆä¸€ä¸ª **dispatch mapï¼ˆåˆ†å‘æ˜ å°„è¡¨ï¼‰**ï¼š

- agent loop åªè´Ÿè´£ä¸¤ä»¶äº‹ï¼š
  1. æŠŠæ¶ˆæ¯å‘ç»™æ¨¡å‹
  2. å¦‚æœæ¨¡å‹è¦ç”¨å·¥å…·ï¼ˆtool_useï¼‰ï¼Œå°±æŠŠ `block.name` å»æ˜ å°„è¡¨é‡ŒæŸ¥ handler æ‰§è¡Œï¼Œå†æŠŠ tool_result å›ç»™æ¨¡å‹
- å·¥å…·æ€ä¹ˆå®ç°ï¼ˆread/write/edit/bashï¼‰ï¼Œéƒ½åœ¨å¾ªç¯å¤–å®ç°æˆç‹¬ç«‹å‡½æ•°

è¿™æ ·ä½ è¦æ‰©å±•å·¥å…·æ—¶ï¼Œåªéœ€è¦ï¼š

- å¢åŠ ä¸€ä¸ª schemaï¼ˆtools æ•°ç»„é‡Œå¤šä¸€ä¸ªå·¥å…·ï¼‰
- å¢åŠ ä¸€ä¸ª handler å‡½æ•°
- åœ¨ `TOOL_HANDLERS` é‡ŒåŠ ä¸€æ¡æ˜ å°„

å¾ªç¯æœ¬èº«å®Œå…¨ä¸ç”¨åŠ¨ã€‚

------

## 3) è¿™å‡ ä¸ªå…³é”®ä»£ç å—åˆ†åˆ«åœ¨å¹²ä»€ä¹ˆï¼Ÿ

### 3.1 `run_read` ç¤ºä¾‹

```
def run_read(path: str, limit: int = None) -> str:
    text = safe_path(path).read_text()
    lines = text.splitlines()
    if limit and limit < len(lines):
        lines = lines[:limit]
    return "\n".join(lines)[:50000]
```

è¿™é‡Œä½“ç°äº†ä¸¤å±‚â€œå®‰å…¨/ç¨³å¥â€ï¼š

- `safe_path(path)`ï¼š**è·¯å¾„æ²™ç®±åŒ–**ï¼Œåªå…è®¸åœ¨ WORKDIR é‡Œè¯»
- `[:50000]`ï¼šå¯¹è¿”å›å†…å®¹åšé•¿åº¦ä¸Šé™ï¼Œé¿å…ä¸€æ¬¡è¯»å·¨å¤§æ–‡ä»¶æŠŠä¸Šä¸‹æ–‡æ’‘çˆ†

å¦å¤– `limit` æ˜¯æŒ‰è¡Œæˆªæ–­ï¼Œæ–¹ä¾¿ â€œåªçœ‹å‰ N è¡Œâ€ã€‚

------

### 3.2 `TOOL_HANDLERS` åˆ†å‘è¡¨

```
TOOL_HANDLERS = {
    "bash":       lambda **kw: run_bash(kw["command"]),
    "read_file":  lambda **kw: run_read(kw["path"], kw.get("limit")),
    "write_file": lambda **kw: run_write(kw["path"], kw["content"]),
    "edit_file":  lambda **kw: run_edit(kw["path"], kw["old_text"],
                                        kw["new_text"]),
}
```

è¿™å°±æ˜¯â€œå·¥å…·å â†’ å¤„ç†å‡½æ•°â€çš„å­—å…¸ã€‚

- æ¨¡å‹è¯´ï¼šæˆ‘è¦ç”¨å·¥å…· `"read_file"`ï¼Œå¹¶ç»™ inputï¼š`{"path": "...", "limit": 20}`
- ä½ çš„ä»£ç æŸ¥è¡¨æ‹¿åˆ° lambdaï¼Œç„¶åæŠŠ `block.input` è§£åŒ…è¿›å»æ‰§è¡Œ
- handler è¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œä½œä¸º tool_result å›ç»™æ¨¡å‹

æ³¨æ„è¿™é‡Œç”¨ `lambda **kw` çš„åŸå› æ˜¯ï¼šä¸åŒå·¥å…· schema å­—æ®µä¸åŒï¼Œç»Ÿä¸€ç”¨ kwargs æ¥æ”¶æœ€çœäº‹ã€‚

------

### 3.3 agent loop é‡Œçš„ dispatch

```
for block in response.content:
    if block.type == "tool_use":
        handler = TOOL_HANDLERS.get(block.name)
        output = handler(**block.input) if handler \
            else f"Unknown tool: {block.name}"
        results.append({
            "type": "tool_result",
            "tool_use_id": block.id,
            "content": output,
        })
messages.append({"role": "user", "content": results})
```

è¿™é‡Œçš„å…³é”®ç‚¹ï¼š

- `response.content` ä¸æ˜¯çº¯æ–‡æœ¬ï¼Œè€Œæ˜¯ä¸€ä¸ªâ€œå—åˆ—è¡¨â€ï¼ˆblocksï¼‰
  - æœ‰çš„å—æ˜¯ `thinking`
  - æœ‰çš„å—æ˜¯ `tool_use`
- ç¢°åˆ° `tool_use` å°±æ‰§è¡Œ
- æŠŠæ‰§è¡Œç»“æœåŒ…è£…æˆï¼š
  - `type: tool_result`
  - `tool_use_id: block.id`ï¼ˆå¯¹åº”è¿™æ¬¡å·¥å…·è°ƒç”¨çš„ idï¼‰
  - `content: output`ï¼ˆå­—ç¬¦ä¸²ï¼‰

å†æŠŠè¿™äº› tool_result ä½œä¸º **user role** çš„å†…å®¹ append å› messagesï¼Œè®©æ¨¡å‹ç»§ç»­ä¸‹ä¸€è½®æ¨ç†/å›ç­”ã€‚

------

## 4) ä½ è´´çš„æ—¥å¿—ç‰‡æ®µåœ¨è¯´ä»€ä¹ˆï¼Ÿ

ä½ è´´äº†ä¸‰æ®µç±»ä¼¼çš„ `Message(...)` æ‰“å°ã€‚å®ƒä»¬å±•ç¤ºçš„æ˜¯ï¼š**æ¨¡å‹è¾“å‡ºäº†ä¸€æ®µ thinkingï¼Œç„¶åè¾“å‡ºäº†ä¸€ä¸ª bash å·¥å…·è°ƒç”¨**ï¼Œæ‰€ä»¥æœ¬è½®åœæ­¢åŸå› æ˜¯ `tool_use`ï¼Œç­‰å¾…ä½ æ‰§è¡Œå·¥å…·å¹¶æŠŠç»“æœå›ä¼ ã€‚

### 4.1 ç¬¬ä¸€æ®µï¼š`ls -la`

```
Message(
  id='05eeeba0ba90928f32ae19f3143d7221',
  content=[
    ThinkingBlock(... thinking='ç”¨æˆ·æƒ³è¦æ‰¾åˆ° scripts ç›®å½•å¹¶è¿”å›å…¶ç›¸å¯¹è·¯å¾„...'),
    ToolUseBlock(id='call_function_67y24wi0gq2d_1',
                 input={'command': 'ls -la'},
                 name='bash',
                 type='tool_use')
  ],
  model='MiniMax-M2.5',
  role='assistant',
  stop_reason='tool_use',
)
```

é€å­—æ®µè§£é‡Šï¼š

- `role='assistant'`ï¼šè¿™æ˜¯æ¨¡å‹ä½œä¸º assistant ç»™å‡ºçš„è¾“å‡º
- `content=[...]`ï¼šè¾“å‡ºç”±å¤šä¸ª block ç»„æˆ
  - `ThinkingBlock(...)`ï¼šæ¨¡å‹çš„â€œæ€è€ƒæ–‡æœ¬â€ï¼ˆä¸ä¸€å®šå±•ç¤ºç»™ç”¨æˆ·ï¼Œå–å†³äºç³»ç»Ÿï¼‰
  - `ToolUseBlock(...)`ï¼šæ¨¡å‹å†³å®šè°ƒç”¨å·¥å…·
- `ToolUseBlock.name='bash'`ï¼šè¦è°ƒç”¨ bash å·¥å…·
- `ToolUseBlock.input={'command': 'ls -la'}`ï¼šbash çš„å‚æ•°æ˜¯ command
- `stop_reason='tool_use'`ï¼šæ¨¡å‹åœåœ¨è¿™é‡Œï¼Œç­‰å¤–éƒ¨æŠŠå·¥å…·è·‘å®Œå†ç»§ç»­

**è¯­ä¹‰ä¸Š**ï¼šç”¨æˆ·è¦æ‰¾ scripts ç›®å½• â†’ æ¨¡å‹å†³å®šå…ˆçœ‹å½“å‰ç›®å½•ç»“æ„ â†’ è°ƒ `ls -la`ã€‚

------

### 4.2 ç¬¬äºŒæ®µï¼šmessages é‡Œå·²ç»è®°å½•äº†ä»€ä¹ˆ

```
[{'role': 'user', 'content': 'å…ˆæ‰¾åˆ°scriptsç›®å½•ï¼Œå¹¶è¿”å›è¯¥ç›®å½•çš„ç›¸å¯¹è·¯å¾„'},
 {'role': 'assistant', 'content': [...]}]
```

è¿™è¯´æ˜ä½ çš„ `messages` å¯¹è¯å†å²é‡Œç°åœ¨æœ‰ä¸¤æ¡ï¼š

1. ç”¨æˆ·è¯·æ±‚
2. assistant çš„è¾“å‡ºï¼ˆåŒ…å« thinking + tool_use blocksï¼‰

ä¸‹ä¸€æ­¥ä½ çš„ agent loop ä¼šï¼š

- æ‰§è¡Œè¿™ä¸ª tool_use
- æŠŠ tool_result append ä¸ºç¬¬ä¸‰æ¡ `role='user'`
- å†å‘ç»™æ¨¡å‹è¿›è¡Œä¸‹ä¸€è½®

------

### 4.3 ç¬¬ä¸‰æ®µï¼šæ£€æŸ¥ scripts ç›®å½•æ˜¯å¦å­˜åœ¨

```
ToolUseBlock(
  input={'command': 'ls -la scripts 2>/dev/null || echo "Directory does not exist"'},
  name='bash'
)
```

è¿™æ¬¡æ¨¡å‹çš„æ„å›¾æ˜¯ï¼šç”¨æˆ·è¦åœ¨ scripts ç›®å½•ä¸‹åˆ›å»ºæ–‡ä»¶ `all.txt`ï¼Œé‚£æˆ‘å…ˆç¡®è®¤ scripts æ˜¯å¦å­˜åœ¨ã€‚

å®ƒç”¨äº†ä¸€å¥ shell å°æŠ€å·§ï¼š

- `ls -la scripts 2>/dev/null`ï¼šå¦‚æœç›®å½•ä¸å­˜åœ¨ï¼ŒæŠŠé”™è¯¯ä¿¡æ¯ä¸¢å¼ƒ
- `|| echo "Directory does not exist"`ï¼šå¦‚æœ ls å¤±è´¥ï¼Œå°±è¾“å‡ºä¸€å¥è¯

è¿™ä¹Ÿæ­£å¥½åè¡¬å‡ºä½ å‰é¢è¯´çš„ç—›ç‚¹ï¼š**ä¸ºäº†ä¸€ä¸ªâ€œåˆ¤æ–­ç›®å½•æ˜¯å¦å­˜åœ¨â€ï¼Œæ¨¡å‹ä¸å¾—ä¸æ‹¼ä¸€æ®µ bash é€»è¾‘**ã€‚åœ¨ s02 é‡Œï¼Œå¦‚æœä½ æœ‰ `read_file` / `write_file` / `list_dir` ä¹‹ç±»ä¸“ç”¨å·¥å…·ï¼Œè¿™ç§é€»è¾‘å¯ä»¥åœ¨å·¥å…·å®ç°é‡Œæ›´å¯é åœ°åšï¼Œä¸å¿…è®©æ¨¡å‹å†™ shellã€‚

------

## 5) æŠŠâ€œä½ è´´çš„æ—¥å¿—â€æ”¾å› s02 çš„å¤§æ¡†æ¶é‡Œ

ä½ è´´çš„è¿™äº› `Message(...)` æ—¥å¿—ï¼Œæœ¬è´¨æ˜¯åœ¨å±•ç¤ºï¼š

- æ¨¡å‹è¾“å‡º tool_use block
- agent loop çœ‹åˆ° `stop_reason='tool_use'`
- dispatch map æ ¹æ® `block.name` æ‰¾ handler
- æ‰§è¡Œå·¥å…·
- æŠŠ tool_result å›ç»™æ¨¡å‹
- æ¨¡å‹ç»§ç»­ä¸‹ä¸€è½®ï¼ˆæ¯”å¦‚çœŸæ­£å›ç­”ï¼šscripts ç›¸å¯¹è·¯å¾„æ˜¯ä»€ä¹ˆï¼Œæˆ–åˆ›å»º all.txtï¼‰

è€Œ s02 çš„æ”¹è¿›åœ¨äºï¼š
 ä»¥å **ä¸å¿…æ¯æ¬¡éƒ½ bash**ï¼Œè¯»å†™ç¼–è¾‘æ–‡ä»¶ä¼šç”¨æ›´å®‰å…¨ã€ç¨³å®šã€å—æ§çš„å·¥å…·ï¼ˆsafe_path æ²™ç®±ä¹Ÿèƒ½å¼ºåˆ¶æ‰§è¡Œï¼‰ã€‚



# é—®é¢˜1

## 1) Dispatch map è§£è€¦ï¼šä¼˜ç‚¹ã€ç¼ºç‚¹ã€ä»¥åŠå…¶ä»–å¸¸è§é›†æˆæ–¹å¼

### ä¼˜ç‚¹ï¼ˆä¸ºä»€ä¹ˆå·¥ç¨‹é‡Œå¾ˆçˆ±ç”¨ï¼‰

- **å¾ªç¯ï¼ˆagent loopï¼‰ç¨³å®š**
   loop åªåšï¼šå‘æ¨¡å‹è¯·æ±‚ â†’ è¯†åˆ« tool_use â†’ åˆ†å‘æ‰§è¡Œ â†’ å›ä¼  tool_resultã€‚
   ä½ ä»¥ååŠ  10 ä¸ªå·¥å…·ã€æ¢ 10 ä¸ªå·¥å…·å®ç°ï¼Œloop éƒ½ä¸ç”¨æ”¹ï¼Œé™ä½å›å½’é£é™©ã€‚
- **å¯æµ‹è¯•æ€§å¼º**
   æ¯ä¸ªå·¥å…· handler æ˜¯â€œè¾“å…¥â†’è¾“å‡ºâ€çš„çº¯å‡½æ•°/è¿‘çº¯å‡½æ•°ï¼š
  - å¯ä»¥å•å…ƒæµ‹è¯• `run_read/run_write/run_edit`
  - å¯ä»¥æ¨¡æ‹Ÿå¼‚å¸¸ã€è¾¹ç•Œã€æƒé™ã€è·¯å¾„æ²™ç®±ç­‰
  - ç”šè‡³å¯ä»¥åš fuzz æµ‹è¯•ï¼ˆæ¯”å¦‚éšæœºç”Ÿæˆ path/å†…å®¹ï¼‰
- **å®‰å…¨ç­–ç•¥é›†ä¸­åœ¨å·¥å…·å±‚**
   `safe_path()`ã€è¾“å‡ºæˆªæ–­ã€ç¦æ­¢å±é™©æ¨¡å¼ï¼Œéƒ½åœ¨ handler é‡Œåšï¼Œæ¯”â€œè®©æ¨¡å‹è‡ªè§‰â€å¯é å¾—å¤šã€‚
- **å‡å°‘æ§åˆ¶æµå¤æ‚åº¦**
   ç”¨ dict lookup æ›¿ä»£ if/elifï¼Œå·¥å…·æ•°é‡å¢é•¿ä¸ä¼šè®© loop å˜æˆä¸€å¨éš¾ç»´æŠ¤çš„åˆ†æ”¯é“¾ã€‚

### ç¼ºç‚¹ / ä½ è¿Ÿæ—©ä¼šé‡åˆ°çš„å‘

- **handler æ¥å£å®¹æ˜“å˜å¾—ä¸ä¸€è‡´**
   æ—©æœŸå·¥å…·å°‘ï¼Œç”¨ `lambda **kw` å¾ˆçˆ½ï¼›å·¥å…·å¤šäº†åï¼š

  - å‚æ•°å‘½åä¸ä¸€è‡´ï¼ˆpath vs file_pathï¼‰
  - è¿”å›æ ¼å¼ä¸ä¸€è‡´ï¼ˆå­—ç¬¦ä¸² vs JSON å­—ç¬¦ä¸² vs äºŒè¿›åˆ¶ï¼‰
  - é”™è¯¯å¤„ç†ä¸ä¸€è‡´ï¼ˆraise vs è¿”å› â€œERROR: â€¦â€ï¼‰

  è§£å†³åŠæ³•é€šå¸¸æ˜¯ï¼š**ç»Ÿä¸€å·¥å…·è¿”å› envelope**ï¼ˆæ¯”å¦‚ `{ok, data, error, meta}`ï¼‰ã€‚

- **å·¥å…·ä¹‹é—´çš„å…±äº«çŠ¶æ€ä¸å¥½ç®¡**
   æœ‰äº›å·¥å…·ä¼šå…±äº«èµ„æºï¼šå·¥ä½œç›®å½•ã€ç¼“å­˜ã€ä¼šè¯ã€æ•°æ®åº“è¿æ¥ã€‚
   dispatch map æœ¬èº«ä¸è§£å†³â€œçŠ¶æ€ç®¡ç†â€ï¼Œä½ éœ€è¦ï¼š

  - æ˜ç¡®å“ªäº›å·¥å…·æ˜¯çº¯å‡½æ•°ï¼Œå“ªäº›éœ€è¦ state
  - ç”¨ `context` å¯¹è±¡æ³¨å…¥ä¾èµ–ï¼ˆloggerã€dbã€workdirã€authã€rate limitï¼‰

- **å·¥å…·å¤šäº†åï¼Œæƒé™/èƒ½åŠ›è¾¹ç•Œæ›´å¤æ‚**
   ä½ ä¼šå¼€å§‹éœ€è¦ï¼š

  - RBAC/allowlistï¼ˆè¿™ä¸ª agent èƒ½ç”¨å“ªäº›å·¥å…·ï¼‰
  - tool-level å®¡è®¡æ—¥å¿—
  - é€Ÿç‡é™åˆ¶ã€é…é¢ã€è¶…æ—¶ã€éš”ç¦»

- **è°ƒè¯•å¯è§‚æµ‹æ€§è¦é¢å¤–å»ºè®¾**
   å“ªä¸ªå·¥å…·è¢«è°ƒç”¨ã€è¾“å…¥è¾“å‡ºå¤šå¤§ã€è€—æ—¶å¤šå°‘ã€å¤±è´¥ç‡å¤šå°‘â€”â€”éœ€è¦åŸ‹ç‚¹ã€‚

------

### è¿˜æœ‰å“ªäº›â€œå·¥å…·è°ƒç”¨ä¸ loop ç»“åˆâ€çš„å¸¸è§æ–¹æ³•ï¼Ÿ

#### æ–¹æ³• Aï¼šif/elif ç¡¬ç¼–ç åˆ†æ”¯ï¼ˆæœ€åŸå§‹ï¼‰

- ä¼˜ç‚¹ï¼šç®€å•ç›´è§‚
- ç¼ºç‚¹ï¼šå·¥å…·ä¸€å¤šå°±ç¾éš¾ï¼Œéš¾æµ‹ã€éš¾æ‰©å±•

#### æ–¹æ³• Bï¼šæ’ä»¶/æ³¨å†Œè¡¨ï¼ˆdispatch map çš„å·¥ç¨‹åŒ–å‡çº§ï¼‰

æœ¬è´¨è¿˜æ˜¯ mapï¼Œä½†æ›´å·¥ç¨‹ï¼š

- è£…é¥°å™¨æ³¨å†Œï¼š`@tool("read_file")`
- è‡ªåŠ¨ä» schema ç”Ÿæˆ handler wrapper
- æ”¯æŒä¸­é—´ä»¶ï¼šæ—¥å¿—/é‰´æƒ/è¶…æ—¶/é‡è¯•/æŒ‡æ ‡

ä½ å¯ä»¥æŠŠå®ƒç†è§£ä¸ºâ€œå¯æ’æ‹”çš„ dispatch mapâ€ã€‚

#### æ–¹æ³• Cï¼šå¤šæ­¥å·¥å…·ç¼–æ’ï¼ˆPlanner + Executorï¼‰

- **Plannerï¼ˆæ¨¡å‹ï¼‰**äº§å‡ºè®¡åˆ’ï¼ˆæ­¥éª¤ã€å·¥å…·ã€ä¾èµ–ï¼‰
- **Executorï¼ˆä»£ç ï¼‰**æŒ‰è®¡åˆ’æ‰§è¡Œã€æ”¶é›†ç»“æœã€å¿…è¦æ—¶å›é—®æ¨¡å‹ä¿®æ­£
- ä¼˜ç‚¹ï¼šå¤æ‚ä»»åŠ¡æ›´ç¨³
- ç¼ºç‚¹ï¼šå®ç°æ›´å¤æ‚ï¼Œéœ€è¦ plan æ ¼å¼ã€å¤±è´¥æ¢å¤ç­–ç•¥

#### æ–¹æ³• Dï¼šå‡½æ•°è°ƒç”¨è·¯ç”±å™¨ï¼ˆè§„åˆ™/æ¨¡å‹æ··åˆï¼‰

ä¸æ˜¯å®Œå…¨äº¤ç»™ LLM å†³å®šç”¨å“ªä¸ªå·¥å…·ï¼Œè€Œæ˜¯ï¼š

- å…ˆç”±ä»£ç /è§„åˆ™åˆ¤æ–­â€œåº”è¯¥ç”¨ä»€ä¹ˆç±»å·¥å…·â€
- LLM åªå¡«å‚æ•°æˆ–åšè§£é‡Š
- é€‚åˆé«˜å®‰å…¨åœºæ™¯ï¼ˆæ¯”å¦‚æ”¯ä»˜ã€åˆ æ•°æ®ï¼‰

#### æ–¹æ³• Eï¼šå·¥å…·è°ƒç”¨ä½œä¸ºâ€œå­ agentâ€ï¼ˆtool = agentï¼‰

æ¯ä¸ªå·¥å…·èƒŒåä¸æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œè€Œæ˜¯ä¸€ä¸ªä¸“ç”¨å° agentï¼š

- ä¾‹ï¼š`coding_agent`ã€`sql_agent`ã€`browser_agent`
- loop è°ƒç”¨çš„æ˜¯â€œå­ agent å…¥å£â€
- ä¼˜ç‚¹ï¼šæ¯ä¸ªå­ agent æœ‰è‡ªå·±çš„ç³»ç»Ÿæç¤ºè¯å’Œå·¥å…·é›†ï¼Œæ›´å¯æ§
- ç¼ºç‚¹ï¼šå¤æ‚ã€è°ƒç”¨æˆæœ¬é«˜

------

## 2) å·¥å…·è¶Šæ¥è¶Šå¤šä¼šæ’‘çˆ†ä¸Šä¸‹æ–‡å—ï¼Ÿä¸ä½¿ç”¨ skills çš„å¸¸è§è§£å†³æ–¹æ¡ˆæ˜¯ä»€ä¹ˆï¼Ÿ

å…ˆè¯´ç»“è®ºï¼š**çœŸæ­£æ’‘çˆ†ä¸Šä¸‹æ–‡çš„é€šå¸¸ä¸æ˜¯â€œdispatch map å˜å¤§â€ï¼Œè€Œæ˜¯â€œä½ æŠŠæ‰€æœ‰å·¥å…·çš„è¯´æ˜/å‚æ•°/schema å…¨å¡è¿›æ¨¡å‹ä¸Šä¸‹æ–‡â€**ã€‚
 dispatch map æ˜¯åœ¨ä»£ç é‡Œï¼Œæ¨¡å‹çœ‹ä¸è§ï¼›æ¨¡å‹çœ‹åˆ°çš„æ˜¯ä½ ä¼ ç»™å®ƒçš„ `tools` å®šä¹‰ï¼ˆschemaã€æè¿°ã€å‚æ•°è¯´æ˜ï¼‰ã€‚

### ä¸ç”¨ skills æ—¶ï¼Œä¸šç•Œæœ€å¸¸è§çš„ 4 ç±»åšæ³•

#### åšæ³• 1ï¼šå·¥å…·é›†åˆ†å±‚/åˆ†ç»„ï¼Œåªæš´éœ²â€œå½“å‰éœ€è¦çš„å·¥å…·â€

- æŠŠå·¥å…·åˆ†æˆåŸŸï¼šæ–‡ä»¶ç±»ã€ç½‘ç»œç±»ã€ä»£ç æ‰§è¡Œç±»ã€æ•°æ®åº“ç±»â€¦â€¦
- æ¯è½®å¯¹è¯åªæŠŠç›¸å…³ç»„çš„ tools ä¼ ç»™æ¨¡å‹
   ä¾‹ï¼šç”¨æˆ·åœ¨å†™ä»£ç  â†’ æš´éœ² read/write/edit/bash
   ç”¨æˆ·åœ¨æŸ¥å¤©æ°” â†’ æš´éœ² weather tool
- è¿™å« **tool gating / tool scoping**ï¼Œæ˜¯æœ€ä¸»æµçš„åšæ³•

å…³é”®ç‚¹ï¼šç”±ä»£ç åšä¸€ä¸ªè½»é‡â€œå·¥å…·é€‰æ‹©å™¨â€

- è§„åˆ™ï¼ˆå…³é”®è¯/çŠ¶æ€æœºï¼‰
- æˆ–ä¸€ä¸ªå°æ¨¡å‹åš tool-rerankï¼ˆæˆæœ¬ä½ï¼‰

#### åšæ³• 2ï¼šä¸¤æ®µå¼è°ƒç”¨ï¼ˆå…ˆé€‰å·¥å…·ï¼Œå†ç»™è¯¦ç»† schemaï¼‰

- ç¬¬ä¸€æ­¥ï¼šåªç»™æ¨¡å‹ä¸€ä¸ªâ€œå·¥å…·ç›®å½•â€ï¼ˆå¾ˆçŸ­ï¼šå·¥å…·å + ä¸€å¥è¯ï¼‰
- æ¨¡å‹å…ˆè¯´ï¼šæˆ‘è¦ç”¨ `read_file`
- ç¬¬äºŒæ­¥ï¼šä½ å†æŠŠ `read_file` çš„å®Œæ•´ schema å‘ç»™å®ƒï¼Œè®©å®ƒå¡«å‚æ•°

å¥½å¤„ï¼š**ç»å¤§å¤šæ•°è½®æ¬¡éƒ½ä¸ç”¨æºå¸¦æ‰€æœ‰ schema**ã€‚

#### åšæ³• 3ï¼šå‹ç¼©å·¥å…·æè¿°ï¼ˆschema ç²¾ç®€ + æè¿°å¤–ç½®ï¼‰

- schema é‡Œåªæ”¾æœ€å¿…è¦å­—æ®µã€ç±»å‹ã€æœ€çŸ­æè¿°
- é•¿æ–‡æ¡£ï¼ˆå®‰å…¨é™åˆ¶ã€ç¤ºä¾‹ã€è¾¹ç•Œæ¡ä»¶ï¼‰ä¸æ”¾ tools é‡Œ
   æ”¹æˆï¼š
  - åœ¨å·¥å…·å®ç°é‡Œå¼ºåˆ¶æ ¡éªŒ
  - å‡ºé”™æ—¶è¿”å›ç»“æ„åŒ–é”™è¯¯ï¼Œè®©æ¨¡å‹è¿­ä»£ä¿®æ­£

è¿™æ˜¯å¾ˆå¤šæ¡†æ¶èµ°å‘æˆç†Ÿåçš„ç°å®é€‰æ‹©ï¼š**æŠŠè§„åˆ™ä» prompt æŒªåˆ°ä»£ç **ã€‚

#### åšæ³• 4ï¼šå·¥å…·æ£€ç´¢ï¼ˆTool Retrievalï¼‰

å½“å·¥å…·ä¸Šç™¾ä¸ªæ—¶ï¼Œå¸¸ç”¨ï¼š

- ç»™æ¯ä¸ªå·¥å…·åšä¸€æ¡ embeddingï¼ˆåå­—+æè¿°+å‚æ•°ï¼‰
- æ¯è½®æ ¹æ®ç”¨æˆ·æ„å›¾æ£€ç´¢ top-k å·¥å…·
- åªæŠŠ top-k å·¥å…· schema æ”¾è¿›ä¸Šä¸‹æ–‡

è¿™å…¶å®å°±æ˜¯â€œskills çš„æ€æƒ³â€ï¼Œä½†ä½ ä¸å« skills ä¹Ÿä¸€æ ·èƒ½åšã€‚

------

### â€œä¸ç”¨ skillsâ€æ—¶ï¼Œè¿˜æœ‰ä¸€ä¸ªå®¹æ˜“å¿½ç•¥ä½†å¾ˆé‡è¦çš„ç‚¹

**è®©å·¥å…·è¿”å›æ›´ç»“æ„åŒ–ã€æ›´çŸ­çš„ç»“æœ**ï¼Œå¦åˆ™è¾“å‡ºä¹Ÿä¼šæ’‘çˆ†ä¸Šä¸‹æ–‡ã€‚

å…¸å‹ç­–ç•¥ï¼š

- å·¥å…·è¿”å› `{summary, data, next_actions}`ï¼Œå¹¶å¼ºåˆ¶æˆªæ–­ data
- å¯¹å¤§å†…å®¹èµ°â€œæ–‡ä»¶å¥æŸ„/å¼•ç”¨â€ç­–ç•¥ï¼šä¿å­˜åˆ°æœ¬åœ°æ–‡ä»¶ï¼Œåªå›ä¼ è·¯å¾„/æ‘˜è¦
- åˆ†é¡µè¯»å–ï¼š`read_file(path, offset, limit)` è€Œä¸æ˜¯ä¸€æ¬¡å…¨è¯»



# é—®é¢˜2

â€œ**å¥æŸ„ï¼ˆhandleï¼‰**â€æ˜¯ä¸ªåœ¨å¾ˆå¤šç³»ç»Ÿé‡Œéƒ½ä¼šå‡ºç°çš„æ¦‚å¿µï¼ˆæ“ä½œç³»ç»Ÿã€æ•°æ®åº“ã€GUIã€æ–‡ä»¶ç³»ç»Ÿã€ç½‘ç»œåº“â€¦â€¦ï¼‰ï¼Œä½†åˆå­¦è€…å¸¸å¸¸åªåœ¨ MySQL / JDBC é‡Œå¬è¿‡ï¼Œå´æ²¡çœŸæ­£ç†è§£ã€‚

æˆ‘ç”¨ **é€šä¿—è§£é‡Š â†’ æŠ€æœ¯å®šä¹‰ â†’ MySQL åœºæ™¯ â†’ ç±»æ¯”** å››å±‚æ¥è®²æ¸…æ¥šã€‚

------

## ä¸€å¥è¯é€šä¿—è§£é‡Š

> **å¥æŸ„ = ä¸€ä¸ªâ€œé—´æ¥å¼•ç”¨çš„å‡­è¯ / IDâ€ï¼Œç”¨æ¥ä»£è¡¨æŸä¸ªèµ„æºï¼Œè€Œä¸æ˜¯èµ„æºæœ¬èº«**

ä½ å¯ä»¥æŠŠå¥æŸ„ç†è§£æˆï¼š

- ä¸æ˜¯æ–‡ä»¶æœ¬èº«ï¼Œè€Œæ˜¯â€œæ–‡ä»¶çš„ç¼–å·â€
- ä¸æ˜¯æ•°æ®åº“è¿æ¥æœ¬èº«ï¼Œè€Œæ˜¯â€œè¿æ¥çš„æ ‡è¯†â€
- ä¸æ˜¯å¯¹è±¡æœ¬èº«ï¼Œè€Œæ˜¯â€œå¯¹è±¡çš„å¼•ç”¨é’¥åŒ™â€

------

## æŠ€æœ¯ä¸€ç‚¹çš„å®šä¹‰

åœ¨è®¡ç®—æœºç³»ç»Ÿä¸­ï¼š

> **Handle æ˜¯ä¸€ä¸ªæŠ½è±¡æ ‡è¯†ç¬¦ï¼Œç”¨æ¥è®©ç¨‹åºè®¿é—®åº•å±‚èµ„æºï¼Œè€Œéšè—èµ„æºçš„çœŸå®å®ç°ç»†èŠ‚**

ç‰¹ç‚¹ï¼š

- é€šå¸¸æ˜¯æ•´æ•°ã€æŒ‡é’ˆã€tokenã€å¼•ç”¨ID
- æœ¬èº«ä¸åŒ…å«èµ„æºå†…å®¹
- ç”±ç³»ç»Ÿç»´æŠ¤æ˜ å°„å…³ç³»ï¼š
   `handle â†’ å®é™…èµ„æº`

------

## ä¸ºä»€ä¹ˆéœ€è¦å¥æŸ„ï¼Ÿ

å› ä¸ºç¨‹åºä¸åº”è¯¥ç›´æ¥æ“ä½œåº•å±‚èµ„æºç»“æ„ï¼š

| å¦‚æœæ²¡æœ‰å¥æŸ„                 | ä¼šå‘ç”Ÿä»€ä¹ˆ       |
| ---------------------------- | ---------------- |
| ç¨‹åºç›´æ¥æ‹¿åˆ°æ–‡ä»¶ç»“æ„ä½“       | å¯ä»¥ä¹±æ”¹ï¼Œç³»ç»Ÿå´© |
| ç¨‹åºç›´æ¥æ‹¿ socket å†…æ ¸å¯¹è±¡   | æé«˜é£é™©         |
| ç¨‹åºç›´æ¥æ‹¿æ•°æ®åº“å†…éƒ¨è¿æ¥å¯¹è±¡ | ä¸å®‰å…¨ã€ä¸ç¨³å®š   |

**å¥æŸ„çš„ä½œç”¨ï¼š**

âœ… éš”ç¦»
 âœ… å®‰å…¨
 âœ… æŠ½è±¡
 âœ… æ˜“ç®¡ç†ç”Ÿå‘½å‘¨æœŸ

------

## MySQL / æ•°æ®åº“é‡Œå¸¸è§çš„â€œå¥æŸ„â€

åœ¨æ•°æ®åº“è¯­å¢ƒé‡Œï¼Œå¥æŸ„è¿™ä¸ªè¯ä¸æ€»æ˜¯æ˜¾å¼è¯´å‡ºæ¥ï¼Œä½†æ¦‚å¿µä¸€ç›´å­˜åœ¨ã€‚

### 1ï¸âƒ£ è¿æ¥å¥æŸ„ï¼ˆConnection Handleï¼‰

å½“ä½ ï¼š

```
mysql -u root -p
```

æœåŠ¡å™¨ä¼šï¼š

- åˆ›å»ºä¸€ä¸ªè¿æ¥å¯¹è±¡
- åˆ†é…ä¸€ä¸ª connection idï¼ˆæ¯”å¦‚ 123ï¼‰

è¿™ä¸ª ID æœ¬è´¨å°±æ˜¯ **è¿æ¥å¥æŸ„**

ä½ çœ‹åˆ°çš„ï¼š

```
SHOW PROCESSLIST;
```

é‡Œé¢çš„ `Id` åˆ—ï¼Œå°±æ˜¯å¥æŸ„çš„ä¸€ç§å½¢å¼ã€‚

------

### 2ï¸âƒ£ æ¸¸æ ‡å¥æŸ„ï¼ˆCursor Handleï¼‰

åœ¨å­˜å‚¨è¿‡ç¨‹ / API ä¸­ï¼š

```
DECLARE cur CURSOR FOR SELECT ...
```

æ•°æ®åº“å†…éƒ¨ä¼šåˆ›å»ºï¼š

- æ¸¸æ ‡å¯¹è±¡
- è¿”å›ä¸€ä¸ªæ ‡è¯†ç¬¦ï¼ˆå¥æŸ„ï¼‰

ç¨‹åºç”¨è¿™ä¸ªå¥æŸ„ï¼š

- FETCH
- CLOSE

------

### 3ï¸âƒ£ è¯­å¥å¥æŸ„ï¼ˆStatement Handleï¼‰

åœ¨ç¼–ç¨‹æ¥å£ä¸­éå¸¸å¸¸è§ï¼š

ä¾‹å¦‚ Pythonï¼š

```
cursor.execute("SELECT * FROM users")
```

JDBCï¼š

```
PreparedStatement ps = conn.prepareStatement(sql);
```

`ps` å°±æ˜¯ä¸€ä¸ªè¯­å¥å¥æŸ„ï¼ˆä»£è¡¨ SQL æ‰§è¡Œå¯¹è±¡ï¼‰

------

### 4ï¸âƒ£ é”å¥æŸ„ / äº‹åŠ¡ä¸Šä¸‹æ–‡

æ•°æ®åº“å†…éƒ¨ç®¡ç†ï¼š

- è¡Œé”
- è¡¨é”
- äº‹åŠ¡çŠ¶æ€

éƒ½æ˜¯é€šè¿‡å¥æŸ„/IDå¼•ç”¨ï¼Œè€Œä¸æ˜¯ç›´æ¥æš´éœ²ç»“æ„ã€‚

------

## ä¸€ä¸ªéå¸¸é‡è¦çš„ç†è§£ï¼ˆå¯¹ agent å¾ˆå…³é”®ï¼‰

> **å¥æŸ„æ˜¯â€œè½»é‡å¼•ç”¨â€ï¼Œé¿å…æŠŠå¤§å¯¹è±¡å¡è¿›ä¸Šä¸‹æ–‡æˆ–è·¨å±‚ä¼ é€’**

è¿™åœ¨ agent / LLM ç³»ç»Ÿé‡Œè¶…çº§å¸¸è§ï¼š

### ä¸¾ä¾‹ï¼šå·¥å…·è¿”å›å¤§æ–‡ä»¶

âŒ ä¸å¥½çš„æ–¹å¼ï¼š

```
tool_result:
<æ•´ä¸ª10ä¸‡è¡Œæ–‡ä»¶å†…å®¹>
```

âœ… å¥½çš„æ–¹å¼ï¼ˆå¥æŸ„æ€æƒ³ï¼‰ï¼š

```
tool_result:
{
  "file_handle": "file_abc123",
  "summary": "...",
  "preview": "å‰200è¡Œ"
}
```

åç»­æ¨¡å‹å†è¯´ï¼š

```
read_file(handle="file_abc123", offset=200)
```

ğŸ‘‰ **å¥æŸ„ = æ¨¡å‹ä¸çœŸå®èµ„æºä¹‹é—´çš„æ¡¥æ¢**

------

## ç”¨ç”Ÿæ´»ç±»æ¯”ç†è§£

| åœºæ™¯     | èµ„æº     | å¥æŸ„          |
| -------- | -------- | ------------- |
| å›¾ä¹¦é¦†   | ä¸€æœ¬ä¹¦   | å€Ÿä¹¦è¯ç¼–å·    |
| é…’åº—     | æˆ¿é—´     | æˆ¿å¡          |
| é“¶è¡Œ     | é’±       | è´¦æˆ·å·        |
| æ–‡ä»¶ç³»ç»Ÿ | æ–‡ä»¶å†…å®¹ | æ–‡ä»¶æè¿°ç¬¦ fd |
| æ•°æ®åº“   | è¿æ¥å¯¹è±¡ | connection id |

ä½ æ‹¿çš„æ˜¯â€œå‡­è¯â€ï¼Œä¸æ˜¯â€œå®ä½“â€ã€‚

------

## å¸¸è§è¯¯åŒº

âŒ å¥æŸ„ä¸æ˜¯æ•°æ®
 âŒ å¥æŸ„ä¸æ˜¯å¯¹è±¡æœ¬èº«
 âŒ å¥æŸ„ä¸æ˜¯è·¯å¾„ï¼ˆè·¯å¾„æ˜¯å®šä½æ–¹å¼ï¼Œå¥æŸ„æ˜¯å·²åˆ†é…å¼•ç”¨ï¼‰

âœ… å¥æŸ„æ˜¯â€œç³»ç»Ÿè®¤å¯çš„è®¿é—®æ ‡è¯†â€

------

## æ€»ç»“ä¸€å¥è¯

> **å¥æŸ„ = ç¨‹åºè®¿é—®èµ„æºçš„â€œé’¥åŒ™ / ID / å¼•ç”¨ä»¤ç‰Œâ€ï¼Œç”¨äºæŠ½è±¡ã€éš”ç¦»å’Œå®‰å…¨ç®¡ç†**

------

å¦‚æœä½ æ­£åœ¨å­¦ agentï¼Œè¿™ä¸ªæ¦‚å¿µéå¸¸é‡è¦ï¼Œå› ä¸ºï¼š

- é•¿æ–‡æœ¬ / å¤§æ–‡ä»¶ / ä¼šè¯çŠ¶æ€ â†’ éƒ½é€‚åˆå¥æŸ„åŒ–
- å¯ä»¥é¿å…ä¸Šä¸‹æ–‡çˆ†ç‚¸
- å¯ä»¥æ”¯æŒåˆ†é¡µã€å»¶è¿ŸåŠ è½½ã€è·¨è½®æ¬¡å¼•ç”¨
